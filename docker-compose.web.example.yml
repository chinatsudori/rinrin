version: "3.9"

services:
  bot:
    image: yuribot:latest
    build: .
    container_name: yuribot
    restart: unless-stopped
    env_file:
      - ./.env
    environment:
      DISCORD_TOKEN: ${DISCORD_TOKEN}
      TZ: America/Los_Angeles
      BOT_DB_PATH: /app/data/bot.sqlite3
    volumes:
      - botdata:/app/data
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - npm_default

  web:
    image: yuribot-web:latest
    build: ./web
    container_name: yuribot-web
    restart: unless-stopped
    environment:
      TZ: America/Los_Angeles
      # Share the same path so the dashboard can read (read-only) the bot's SQLite database
      BOT_DB_PATH: /app/data/bot.sqlite3
    volumes:
      - botdata:/app/data:ro
    # Expose 5780 for Nginx Proxy Manager to route yuri.icebrand.dev -> this service
    ports:
      - "5780:5780"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1:5780/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - npm_default

networks:
  npm_default:
    external: true

volumes:
  botdata:
