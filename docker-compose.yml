version: "3.9"

services:
  lavalink:
    image: ghcr.io/lavalink-devs/lavalink:3.7.11
    container_name: lavalink
    restart: unless-stopped
    environment:
      # Core server config
      SERVER_PORT: 2333
      LAVALINK_SERVER_PASSWORD: ${LAVALINK_PASSWORD:-youshallnotpass}

      # Optional: give the JVM sane defaults (tune to your box)
      _JAVA_OPTIONS: "-Xms128m -Xmx512m"

      # Optional: timezone
      TZ: ${TZ:-America/Los_Angeles}

    # No host port needed; the bot talks to it over the compose network by name
    # If you want to expose to host for debugging, uncomment:
    # ports:
    #   - "2333:2333"

    # Don’t make this read-only; Lavalink may write caches/logs
    read_only: false

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

    networks:
      - npm_default

  bot:
    image: yuribot:latest
    build: .
    container_name: yuribot
    restart: unless-stopped

    env_file:
      - ./.env
    environment:
      TZ: ${TZ:-America/Los_Angeles}
      DISCORD_TOKEN: ${DISCORD_TOKEN}
      BOT_DB_PATH: ${BOT_DB_PATH:-/app/data/bot.sqlite3}

      # Lavalink wiring — point at the lavalink service
      LAVALINK_URL: ${LAVALINK_URL:-http://lavalink:2333}
      LAVALINK_PASSWORD: ${LAVALINK_PASSWORD:-youshallnotpass}
      # Optional niceties
      LAVALINK_NAME: ${LAVALINK_NAME:-MAIN}
      # LAVALINK_RESUME_KEY: ${LAVALINK_RESUME_KEY:-yuribot}

    volumes:
      - botdata:/app/data:rw

    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=64m
    cap_drop: ["ALL"]
    security_opt:
      - no-new-privileges:true

    # Bot health remains as-is (independent of Lavalink)
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request,sys; sys.exit(0 if urllib.request.urlopen('http://127.0.0.1:8080/health',timeout=5).getcode()==200 else 1)"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s

    stop_signal: SIGINT
    stop_grace_period: 20s

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

    # Start after lavalink so DNS is ready; bot will still retry if node isn't up yet.
    depends_on:
      - lavalink

    networks:
      - npm_default

  web:
    image: yuribot-web:latest
    build: ./web
    container_name: yuribot-web
    restart: unless-stopped

    env_file:
      - ./.env
    environment:
      TZ: ${TZ:-America/Los_Angeles}
      BOT_DB_PATH: ${BOT_DB_PATH:-/app/data/bot.sqlite3}
      LOG_PATH: ${LOG_PATH:-/app/data/bot.log}

    volumes:
      - botdata:/app/data:ro

    ports:
      - "5780:5780"

    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request,sys; sys.exit(0 if urllib.request.urlopen('http://127.0.0.1:5780/health',timeout=5).getcode()==200 else 1)"]
      interval: 30m
      timeout: 5s
      retries: 3
      start_period: 20s

    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=64m
    cap_drop: ["ALL"]
    security_opt:
      - no-new-privileges:true

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

    networks:
      - npm_default

networks:
  npm_default:
    external: true

volumes:
  botdata:
