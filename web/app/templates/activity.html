<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Yuri Dashboard (Embedded)</title>
  <script src="https://discord.com/sdk.js"></script>
  <style>
    body { font-family: ui-sans-serif, system-ui; margin: 0; padding: 1rem; }
    .card { border: 1px solid #6664; border-radius: 12px; padding: 1rem; }
  </style>
</head>
<body>
  <div class="card">
    <h3>Starting embedded session…</h3>
    <div id="msg">Initializing…</div>
  </div>
 <script src="https://discord.com/sdk.js"></script>
<script>
(async () => {
  const clientId  = "{{ client_id }}";     // e.g. 1266...
  const redirect  = "{{ redirect_uri }}";  // e.g. https://yuri.icebrand.dev/auth/callback
  const nextPath  = "{{ next_after_login }}"; // e.g. /admin

  const show = (msg) => { const el = document.getElementById("msg"); if (el) el.textContent = msg; console.error(msg); };

  try {
    const SDK = window.DiscordSDK;
    if (!SDK) {
      throw new Error("Discord SDK failed to load. Check CSP (script-src) and that you're inside Discord.");
    }

    // Normalize SDK instance across shapes
    let discord;
    if (typeof SDK === "function") {
      // Classic: DiscordSDK is a constructor
      discord = new SDK(clientId);
    } else if (typeof SDK?.DiscordSDK === "function") {
      // Namespaced constructor
      discord = new SDK.DiscordSDK(clientId);
    } else if (typeof SDK?.Client === "function") {
      // Rare older shape
      discord = new SDK.Client(clientId);
    } else if (typeof SDK?.ready === "function") {
      // Already-instantiated object with .ready/.commands
      discord = SDK;
    } else {
      throw new Error("Unsupported Discord SDK global shape.");
    }

    await discord.ready();

    // Ask for an OAuth2 code inside the embedded app
    const { code } = await discord.commands.authorize({
      client_id: clientId,
      response_type: "code",
      scope: ["identify", "guilds.members.read"],
      redirect_uri: redirect
    });

    // Exchange the code for a token + session cookie
    const r = await fetch("/auth/activity-exchange", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify({ code, next: nextPath })
    });
    if (!r.ok) throw new Error(`Exchange failed: ${r.status}`);

    // Land on your gated page (still embedded)
    window.location.replace(nextPath);
  } catch (e) {
    show("Auth error: " + (e?.message || e));
  }
})();
</script>

</body>
</html>
